`<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz - PrepSense AI</title>
    <style>
        :root {
            --primary-dark: #122C4F;
            --background-cream: #FBF9E3;
            --accent-yellow: #F0D637;
            --accent-blue: #5B88B2;
            --white: #FFFFFF;
            --light-gray: #F5F3ED;
            --shadow-sm: 0 2px 8px rgba(18, 44, 79, 0.08);
            --shadow-md: 0 4px 16px rgba(18, 44, 79, 0.12);
            --shadow-lg: 0 8px 24px rgba(18, 44, 79, 0.15);
        }

        /* PAGE TRANSITION ANIMATION */
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .page-transition-overlay {
            position: fixed;
            inset: 0;
            background: var(--background-cream);
            z-index: 9999;
            pointer-events: none;
            opacity: 0;
        }

        .page-transition-overlay.fade-out {
            animation: fadeOut 0.6s ease-out forwards;
        }

        .page-transition-overlay.fade-in {
            animation: fadeIn 0.4s ease-in forwards;
            pointer-events: auto;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-cream);
            color: var(--primary-dark);
        }

        .quiz-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* SIDEBAR */
        .quiz-sidebar {
            width: 250px;
            background: linear-gradient(180deg, var(--primary-dark) 0%, #0f1f37 100%);
            padding: 30px 20px;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
        }

        .quiz-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 30px;
            color: var(--accent-yellow);
            font-weight: 700;
            font-size: 16px;
        }

        .quiz-brand-icon {
            width: 32px;
            height: 32px;
            background: var(--accent-yellow);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-dark);
            font-weight: bold;
        }

        /* MAIN QUIZ AREA */
        .quiz-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .quiz-header {
            background-color: var(--white);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-sm);
            border-bottom: 1px solid rgba(18, 44, 79, 0.05);
        }

        .quiz-timer {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary-dark);
            min-width: 140px;
            text-align: right;
        }

        .quiz-timer.warning {
            color: #ff9800;
        }

        .quiz-timer.critical {
            color: #ff6b6b;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .quiz-header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .quiz-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary-dark);
        }

        .quiz-subject {
            font-size: 14px;
            color: var(--accent-blue);
            font-weight: 600;
        }

        .quiz-timer {
            background: linear-gradient(135deg, var(--accent-yellow) 0%, #f5c61a 100%);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 700;
            min-width: 140px;
            text-align: center;
        }

        .quiz-timer.warning {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* PROGRESS BAR */
        .quiz-progress-section {
            padding: 20px 30px;
            background: var(--light-gray);
            border-bottom: 1px solid rgba(18, 44, 79, 0.05);
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .progress-label {
            font-size: 12px;
            font-weight: 700;
            color: var(--primary-dark);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .progress-bar-container {
            width: 100%;
            height: 6px;
            background: rgba(18, 44, 79, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-yellow) 0%, #F0D637 100%);
            border-radius: 3px;
            transition: width 0.4s ease;
        }

        /* CONFIRMATION MODAL */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            border-radius: 16px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 12px;
        }

        .modal-body {
            font-size: 14px;
            color: #7a8290;
            margin-bottom: 24px;
            line-height: 1.6;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-btn-confirm {
            background: var(--primary-dark);
            color: white;
        }

        .modal-btn-confirm:hover {
            background: #0a1630;
        }

        .modal-btn-cancel {
            background: rgba(18, 44, 79, 0.1);
            color: var(--primary-dark);
        }

        .modal-btn-cancel:hover {
            background: rgba(18, 44, 79, 0.15);
        }

        /* QUIZ CONTENT */
        .quiz-content {
            padding: 40px;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .quiz-card {
            background: var(--white);
            padding: 40px;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            max-width: 700px;
            width: 100%;
        }

        .question-progress {
            font-size: 12px;
            color: #7a8290;
            font-weight: 700;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .question-text {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-bottom: 30px;
        }

        .option-btn {
            padding: 16px;
            border: 2px solid rgba(18, 44, 79, 0.1);
            border-radius: 12px;
            background: var(--white);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            font-size: 14px;
            font-weight: 500;
            color: var(--primary-dark);
        }

        .option-btn:hover {
            background-color: rgba(240, 214, 55, 0.1);
            border-color: var(--accent-yellow);
        }

        .option-btn.selected {
            background-color: var(--accent-yellow);
            border-color: var(--accent-yellow);
            font-weight: 700;
        }

        .option-btn.correct {
            background-color: #d4edda;
            border-color: #28a745;
        }

        .option-btn.incorrect {
            background-color: #f8d7da;
            border-color: #dc3545;
        }

        .quiz-buttons {
            display: flex;
            gap: 12px;
            justify-content: space-between;
        }

        /* MODAL STYLES */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(18, 44, 79, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            border-radius: 16px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 12px 48px rgba(18, 44, 79, 0.2);
        }

        .modal-header {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 12px;
        }

        .modal-body {
            font-size: 14px;
            color: #7a8290;
            margin-bottom: 28px;
            line-height: 1.6;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
        }

        .modal-button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-button-confirm {
            background: var(--primary-dark);
            color: white;
        }

        .modal-button-confirm:hover {
            background: #0a1630;
        }

        .modal-button-cancel {
            background: rgba(18, 44, 79, 0.1);
            color: var(--primary-dark);
        }

        .modal-button-cancel:hover {
            background: rgba(18, 44, 79, 0.15);
        }

        .btn {
            padding: 12px 28px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background-color: var(--primary-dark);
            color: white;
        }

        .btn-primary:hover {
            background-color: #0a1630;
            transform: translateY(-2px);
        }

        .btn-primary:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background-color: transparent;
            color: var(--primary-dark);
            border: 2px solid rgba(18, 44, 79, 0.1);
        }

        .btn-secondary:hover {
            border-color: var(--accent-yellow);
            background-color: rgba(240, 214, 55, 0.05);
        }

        /* RESULT MODAL */
        /* LEARNING REPORT STYLES */
        .learning-report {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .report-section {
            background: var(--white);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow-md);
        }

        .score-circle-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .score-circle {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            background: conic-gradient(var(--accent-yellow) 0deg, var(--accent-yellow) var(--score-progress), rgba(18, 44, 79, 0.1) var(--score-progress), rgba(18, 44, 79, 0.1) 360deg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 32px rgba(240, 214, 55, 0.2);
        }

        .score-value {
            font-size: 48px;
            font-weight: 800;
            color: var(--primary-dark);
        }

        .score-label {
            font-size: 12px;
            color: #7a8290;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 700;
        }

        .breakdown-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
            margin: 20px 0;
        }

        .breakdown-card {
            text-align: center;
            padding: 20px 16px;
            border-radius: 12px;
            border: 2px solid rgba(18, 44, 79, 0.1);
        }

        .breakdown-card.correct {
            background: rgba(76, 175, 80, 0.08);
            border-color: #4caf50;
        }

        .breakdown-card.incorrect {
            background: rgba(255, 107, 107, 0.08);
            border-color: #ff6b6b;
        }

        .breakdown-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .breakdown-count {
            font-size: 28px;
            font-weight: 800;
            color: var(--primary-dark);
        }

        .breakdown-label {
            font-size: 12px;
            color: #7a8290;
            margin-top: 4px;
            font-weight: 600;
        }

        .concepts-section h3 {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 16px;
        }

        .concept-item {
            background: var(--light-gray);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            border-left: 4px solid var(--accent-yellow);
        }

        .concept-item.correct {
            border-left-color: #4caf50;
            background: rgba(76, 175, 80, 0.08);
        }

        .concept-item.incorrect {
            border-left-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.08);
        }

        .concept-title {
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 6px;
        }

        .concept-text {
            font-size: 13px;
            color: #7a8290;
            line-height: 1.6;
        }

        .ai-advice-card {
            background: linear-gradient(135deg, rgba(91, 136, 178, 0.1) 0%, rgba(240, 214, 55, 0.1) 100%);
            border: 2px solid var(--accent-blue);
            border-radius: 16px;
            padding: 24px;
        }

        .ai-advice-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-dark);
        }

        .ai-advice-text {
            font-size: 14px;
            color: var(--primary-dark);
            line-height: 1.8;
        }

        .ai-advice-text ul {
            margin: 12px 0 0 20px;
            padding: 0;
        }

        .ai-advice-text li {
            margin-bottom: 8px;
            color: #7a8290;
        }

        /* RESULT MODAL */
        .result-card {
            display: none;
            text-align: left;
        }

        .result-card.show {
            display: block;
        }

        .result-score {
            font-size: 48px;
            font-weight: 700;
            color: var(--accent-yellow);
            margin-bottom: 20px;
        }

        .result-label {
            font-size: 14px;
            color: #7a8290;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 20px;
        }

        .feedback-text {
            font-size: 14px;
            color: var(--primary-dark);
            line-height: 1.8;
            margin: 20px 0;
            background-color: rgba(240, 214, 55, 0.1);
            padding: 16px;
            border-left: 4px solid var(--accent-yellow);
            border-radius: 8px;
            text-align: left;
        }

        .tips-box {
            background-color: #f0f8ff;
            padding: 16px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid var(--accent-blue);
        }

        .tips-box strong {
            display: block;
            margin-bottom: 8px;
        }

        .weak-topic-tag {
            display: inline-block;
            background-color: #ff9a56;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 15px;
        }

        @media (max-width: 768px) {
            .quiz-container {
                flex-direction: column;
            }

            .quiz-sidebar {
                width: 100%;
                height: auto;
                padding: 15px;
                flex-direction: row;
            }

            .quiz-header {
                flex-wrap: wrap;
                padding: 15px 20px;
            }

            .quiz-content {
                padding: 20px;
            }

            .quiz-card {
                padding: 25px;
            }

            .result-score {
                font-size: 36px;
            }
        }
    </style>
</head>
<body>
    <div class="quiz-container">
        <!-- SIDEBAR -->
        <aside class="quiz-sidebar">
            <div class="quiz-brand">
                <div class="quiz-brand-icon">P</div>
                <span>PrepSense</span>
            </div>
            <div style="flex: 1;"></div>
            <a href="#" onclick="handleNavigation('prepsense-dashboard.html')" style="color: #a8b8cc; text-decoration: none; padding: 12px; text-align: center; border-radius: 8px; font-weight: 600; transition: all 0.3s;">‚Üê Back to Dashboard</a>
        </aside>

        <!-- MAIN AREA -->
        <div class="quiz-main">
            <!-- HEADER -->
            <header class="quiz-header">
                <div class="quiz-header-left">
                    <div>
                        <div class="quiz-title" id="quizTitle">Physics Quiz</div>
                        <div class="quiz-subject" id="quizSubject">Motion</div>
                    </div>
                </div>
                <div class="quiz-timer" id="quizTimer">‚è± 5:00</div>
            </header>

            <!-- PROGRESS BAR SECTION -->
            <div class="quiz-progress-section">
                <div class="progress-info">
                    <span class="progress-label" id="progressLabel">Question 1/5</span>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar" style="width: 0%;"></div>
                </div>
            </div>

            <!-- CONTENT -->
            <div class="quiz-content">
                <div class="quiz-card" id="quizCardContainer">
                    <!-- QUESTION VIEW -->
                    <div id="questionView">
                        <div class="question-progress" id="questionProgress">Question 1/5</div>
                        <div class="question-text" id="questionText">What is the SI unit of velocity?</div>
                        <div class="options-grid" id="optionsGrid">
                            <!-- Options will be inserted here -->
                        </div>
                        <div class="quiz-buttons">
                            <button class="btn btn-secondary" onclick="goBack()">‚Üê Back</button>
                            <button class="btn btn-primary" id="nextBtn" onclick="submitAnswer()" disabled>Submit Answer</button>
                        </div>
                    </div>

                    <!-- RESULT VIEW -->
                    <div id="resultView" class="result-card">
                        <div class="result-score" id="resultScore">3/5</div>
                        <div class="result-label">Your Score</div>
                        
                        <div class="feedback-text" id="feedbackText">
                            You selected the wrong option. Let me explain...
                        </div>

                        <div class="tips-box" id="tipsBox">
                            <strong>üí° Key Concept:</strong>
                            <div id="tipsContent">Velocity is a vector quantity with both magnitude and direction.</div>
                        </div>

                        <div id="weakTopicContainer"></div>

                        <div class="quiz-buttons">
                            <button class="btn btn-primary" onclick="nextQuestion()">Next Question ‚Üí</button>
                        </div>
                    </div>

                    <!-- FINAL RESULTS - LEARNING REPORT -->
                    <div id="finalResultsView" style="padding: 40px 20px;">
                        <div class="learning-report">
                            <!-- SCORE CIRCLE -->
                            <div class="score-circle-container">
                                <div class="score-circle" id="scoreCircleContainer">
                                    <div class="score-value" id="reportScore">4</div>
                                    <div class="score-label">Out of 5</div>
                                </div>
                            </div>

                            <!-- BREAKDOWN -->
                            <div class="report-section">
                                <h3 style="font-size: 16px; font-weight: 700; color: var(--primary-dark); margin-bottom: 20px;">Performance Breakdown</h3>
                                <div class="breakdown-container">
                                    <div class="breakdown-card correct">
                                        <div class="breakdown-icon">‚úÖ</div>
                                        <div class="breakdown-count" id="correctCount">4</div>
                                        <div class="breakdown-label">Correct</div>
                                    </div>
                                    <div class="breakdown-card incorrect">
                                        <div class="breakdown-icon">‚ùå</div>
                                        <div class="breakdown-count" id="incorrectCount">1</div>
                                        <div class="breakdown-label">Incorrect</div>
                                    </div>
                                </div>
                            </div>

                            <!-- CONCEPTS -->
                            <div class="report-section concepts-section" id="conceptsSection">
                                <h3>Key Concepts Covered</h3>
                                <div id="conceptsList"></div>
                            </div>

                            <!-- AI ADVICE -->
                            <div class="report-section ai-advice-card">
                                <div class="ai-advice-header">
                                    <span style="font-size: 24px;">ü§ñ</span>
                                    <div>
                                        <div style="font-weight: 700; color: var(--primary-dark);">AI Study Advice</div>
                                        <div style="font-size: 12px; color: #7a8290;">Based on your performance</div>
                                    </div>
                                </div>
                                <div id="aiAdvice" style="margin-top: 16px; padding: 16px; background: rgba(255, 255, 255, 0.5); border-radius: 8px; font-size: 14px; color: var(--primary-dark); line-height: 1.6;"></div>
                            </div>

                            <!-- ACTION BUTTONS -->
                            <div class="quiz-buttons" style="margin-top: 28px;">
                                <button class="btn btn-secondary" onclick="retryQuiz()">üîÑ Retry Quiz</button>
                                <button class="btn btn-primary" onclick="generateStudyPlan()">üìö Study Plan ‚Üí</button>
                            </div>
                            <button class="btn btn-secondary" onclick="handleNavigation('prepsense-dashboard.html')" style="width: 100%; margin-top: 12px;">‚Üê Back to Dashboard</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SUBMIT CONFIRMATION MODAL -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal-content">
            <div class="modal-header">Confirm Your Answer?</div>
            <div class="modal-body">Once submitted, you won't be able to change your answer. Make sure you've selected the correct option.</div>
            <div class="modal-buttons">
                <button class="modal-button modal-button-cancel" onclick="closeConfirmModal()">Go Back</button>
                <button class="modal-button modal-button-confirm" onclick="confirmSubmit()">Submit Answer</button>
            </div>
        </div>
    </div>

    <script>
        // QUIZ DATA BY SUBJECT
        const quizData = {
            Physics: {
                Motion: [
                    {
                        question: "What is the SI unit of velocity?",
                        options: ["m/s", "km", "m", "s"],
                        correct: 0,
                        explanation: "Velocity is measured in meters per second (m/s), which represents distance traveled per unit time."
                    },
                    {
                        question: "Which of the following is a scalar quantity?",
                        options: ["Displacement", "Velocity", "Speed", "Acceleration"],
                        correct: 2,
                        explanation: "Speed is a scalar quantity as it only has magnitude. Displacement, velocity, and acceleration are vectors."
                    },
                    {
                        question: "If an object moves with constant velocity, its acceleration is:",
                        options: ["Positive", "Negative", "Zero", "Variable"],
                        correct: 2,
                        explanation: "When velocity is constant, there is no change in velocity, so acceleration = 0."
                    },
                    {
                        question: "What is the SI unit of acceleration?",
                        options: ["m", "m/s", "m/s¬≤", "km/h"],
                        correct: 2,
                        explanation: "Acceleration is the rate of change of velocity, measured in meters per second squared (m/s¬≤)."
                    },
                    {
                        question: "A car travels 100 m in 5 seconds. What is its average speed?",
                        options: ["20 m/s", "500 m/s", "5 m/s", "100 m/s"],
                        correct: 0,
                        explanation: "Average speed = Total distance / Total time = 100 m / 5 s = 20 m/s."
                    }
                ]
            },
            Maths: {
                Trigonometry: [
                    {
                        question: "What is sin(90¬∞)?",
                        options: ["0", "1", "‚àö2/2", "-1"],
                        correct: 1,
                        explanation: "sin(90¬∞) = 1. This is a fundamental trigonometric value."
                    },
                    {
                        question: "What is cos(0¬∞)?",
                        options: ["0", "1", "-1", "‚àû"],
                        correct: 1,
                        explanation: "cos(0¬∞) = 1. Cosine of 0 degrees is always 1."
                    },
                    {
                        question: "Find tan(45¬∞):",
                        options: ["0", "1", "‚àö3", "‚àö2"],
                        correct: 1,
                        explanation: "tan(45¬∞) = 1. At 45 degrees, sine and cosine are equal, so their ratio is 1."
                    },
                    {
                        question: "What is the value of sin¬≤Œ∏ + cos¬≤Œ∏?",
                        options: ["0", "1", "2", "Œ∏"],
                        correct: 1,
                        explanation: "This is the Pythagorean identity: sin¬≤Œ∏ + cos¬≤Œ∏ = 1 for all values of Œ∏."
                    },
                    {
                        question: "If tan(Œ∏) = 3/4, what is the value of sin(Œ∏)?",
                        options: ["3/5", "4/5", "3/4", "5/3"],
                        correct: 0,
                        explanation: "Using the Pythagorean theorem: if tan(Œ∏) = 3/4, then sin(Œ∏) = 3/5 and cos(Œ∏) = 4/5."
                    }
                ]
            },
            Chemistry: {
                "Acids & Bases": [
                    {
                        question: "What is the pH of a neutral solution?",
                        options: ["0", "7", "14", "1"],
                        correct: 1,
                        explanation: "A neutral solution has pH = 7. pH < 7 is acidic and pH > 7 is basic."
                    },
                    {
                        question: "Which of the following is a strong acid?",
                        options: ["Acetic acid", "Hydrochloric acid", "Carbonic acid", "Weak acid"],
                        correct: 1,
                        explanation: "Hydrochloric acid (HCl) is a strong acid that completely dissociates in water."
                    },
                    {
                        question: "What is the conjugate base of HCl?",
                        options: ["Cl‚Åª", "H‚Å∫", "ClO‚Åª", "HCl‚ÇÇ‚Åª"],
                        correct: 0,
                        explanation: "When HCl loses a proton, it forms Cl‚Åª, which is its conjugate base."
                    },
                    {
                        question: "A solution with pH = 2 is:",
                        options: ["Basic", "Neutral", "Acidic", "Alkaline"],
                        correct: 2,
                        explanation: "pH < 7 indicates an acidic solution. pH = 2 means a strongly acidic solution."
                    },
                    {
                        question: "What is the pH of a solution with [H‚Å∫] = 10‚Åª‚Åµ?",
                        options: ["5", "9", "14", "-5"],
                        correct: 0,
                        explanation: "pH = -log[H‚Å∫] = -log(10‚Åª‚Åµ) = 5."
                    }
                ]
            },
            Biology: {
                Photosynthesis: [
                    {
                        question: "What is the primary pigment in photosynthesis?",
                        options: ["Carotenoid", "Chlorophyll", "Xanthophyll", "Hemoglobin"],
                        correct: 1,
                        explanation: "Chlorophyll is the main pigment that absorbs light energy in photosynthesis."
                    },
                    {
                        question: "Where do the light reactions of photosynthesis occur?",
                        options: ["Stroma", "Thylakoid membrane", "Mitochondria", "Nucleus"],
                        correct: 1,
                        explanation: "Light reactions occur in the thylakoid membrane of the chloroplast."
                    },
                    {
                        question: "What is produced during the light reactions?",
                        options: ["Glucose", "ATP and NADPH", "CO‚ÇÇ", "Water"],
                        correct: 1,
                        explanation: "Light reactions produce ATP and NADPH, which are used in the Calvin cycle."
                    },
                    {
                        question: "The Calvin cycle produces:",
                        options: ["ATP", "NADPH", "Glucose", "O‚ÇÇ"],
                        correct: 2,
                        explanation: "The Calvin cycle (dark reactions) uses ATP and NADPH to produce glucose."
                    },
                    {
                        question: "What is the overall equation for photosynthesis?",
                        options: ["6CO‚ÇÇ + 6H‚ÇÇO ‚Üí C‚ÇÜH‚ÇÅ‚ÇÇO‚ÇÜ + 6O‚ÇÇ", "C‚ÇÜH‚ÇÅ‚ÇÇO‚ÇÜ + 6O‚ÇÇ ‚Üí 6CO‚ÇÇ + 6H‚ÇÇO", "CO‚ÇÇ + H‚ÇÇO ‚Üí C‚ÇÇH‚ÇÑO", "6O‚ÇÇ ‚Üí 6CO‚ÇÇ + H‚ÇÇO"],
                        correct: 0,
                        explanation: "6CO‚ÇÇ + 6H‚ÇÇO + light energy ‚Üí C‚ÇÜH‚ÇÅ‚ÇÇO‚ÇÜ + 6O‚ÇÇ. This shows glucose and oxygen production."
                    }
                ]
            }
        };

        // STATE
        let currentSubject = 'Physics';
        let currentTopic = 'Motion';
        let currentQuestionIndex = 0;
        let currentQuestions = [];
        let selectedAnswers = [];
        let scores = [];
        let startTime = Date.now();

        // UTILITY FUNCTIONS
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function getWeakTopics() {
            const studentID = localStorage.getItem('studentID') || 'demo-student';
            const attemptsKey = `attempts_${studentID}`;
            let attempts = [];
            try { attempts = JSON.parse(localStorage.getItem(attemptsKey) || '[]'); } catch(e) {}
            
            const weakTopics = [];
            attempts.forEach(attempt => {
                const accuracy = attempt.accuracy || ((attempt.score / attempt.outOf) * 100);
                if (accuracy < 75) {
                    weakTopics.push({ subject: attempt.subject, topic: attempt.topic, accuracy: accuracy });
                }
            });
            return weakTopics;
        }

        function selectQuizQuestions() {
            // Allow planTopics to be passed via URL (re-run plan). Format: planTopics=Topic1,Topic2
            const params = new URLSearchParams(window.location.search);
            const planTopicsParam = params.get('planTopics');

            const weakTopics = getWeakTopics();
            let topicsToUse = [];

            if (planTopicsParam && planTopicsParam.length > 0) {
                topicsToUse = planTopicsParam.split(',').map(t => t.trim()).filter(Boolean);
            } else {
                // Check if there are weak topics in current subject
                const weakInSubject = weakTopics.filter(w => w.subject === currentSubject);
                if (weakInSubject.length > 0) {
                    topicsToUse = weakInSubject.slice(0, 2).map(w => w.topic);
                }
            }

            // Get available topics
            const allTopics = Object.keys(quizData[currentSubject] || {});
            if (topicsToUse.length === 0) {
                topicsToUse = allTopics;
            }

            // Set currentTopic to first selected topic for display
            currentTopic = topicsToUse[0] || allTopics[0] || currentTopic;

            // Collect and shuffle questions
            let questionsPool = [];
            topicsToUse.forEach(topicName => {
                if (quizData[currentSubject] && quizData[currentSubject][topicName]) {
                    questionsPool = questionsPool.concat(quizData[currentSubject][topicName]);
                }
            });

            // If no questions found, fallback to first topic
            if (questionsPool.length === 0 && allTopics.length > 0) {
                currentTopic = allTopics[0];
                questionsPool = quizData[currentSubject][currentTopic] || [];
            }

            // Shuffle and return first 5
            return shuffleArray(questionsPool).slice(0, 5);
        }

        // === Progress Tracking Functions ===
        function _getProgressKeyQuiz(studentID){ return `progress_${studentID}`; }

        function initializeProgressQuiz(){
            const studentID = localStorage.getItem('studentID') || 'demo-student';
            const key = _getProgressKeyQuiz(studentID);
            try{
                const existing = JSON.parse(localStorage.getItem(key) || 'null');
                if(existing) return existing;
            }catch(e){ }
            const progress = {
                quizzesAttempted: 0,
                totalQuestions: 0,
                correctAnswers: 0,
                subjectStats: {
                    Physics: {attempts:0, correct:0},
                    Maths: {attempts:0, correct:0},
                    Chemistry: {attempts:0, correct:0},
                    Biology: {attempts:0, correct:0}
                }
            };
            try{ localStorage.setItem(key, JSON.stringify(progress)); }catch(e){}
            return progress;
        }

        function loadProgressQuiz(){
            const studentID = localStorage.getItem('studentID') || 'demo-student';
            const key = _getProgressKeyQuiz(studentID);
            try{ return JSON.parse(localStorage.getItem(key) || 'null') || null; }catch(e){ return null; }
        }

        function saveProgressQuiz(progress){
            const studentID = localStorage.getItem('studentID') || 'demo-student';
            const key = _getProgressKeyQuiz(studentID);
            try{ localStorage.setItem(key, JSON.stringify(progress)); }catch(e){}
        }

        function updateProgressQuiz(subject, correct, total){
            const studentID = localStorage.getItem('studentID') || 'demo-student';
            let progress = loadProgressQuiz();
            if(!progress) progress = initializeProgressQuiz();
            progress.quizzesAttempted = (progress.quizzesAttempted || 0) + 1;
            progress.totalQuestions = (progress.totalQuestions || 0) + (total || 0);
            progress.correctAnswers = (progress.correctAnswers || 0) + (correct || 0);
            if(!progress.subjectStats) progress.subjectStats = {Physics:{attempts:0,correct:0},Maths:{attempts:0,correct:0},Chemistry:{attempts:0,correct:0},Biology:{attempts:0,correct:0}};
            if(!progress.subjectStats[subject]) progress.subjectStats[subject] = {attempts:0, correct:0};
            progress.subjectStats[subject].attempts += (total || 0);
            progress.subjectStats[subject].correct += (correct || 0);
            saveProgressQuiz(progress);
            return progress;
        }

        // INIT
        document.addEventListener('DOMContentLoaded', function() {
            const params = new URLSearchParams(window.location.search);
            currentSubject = params.get('subject') || 'Physics';
            
            // Load and prepare questions
            if(quizData[currentSubject]){
                const topicKey = Object.keys(quizData[currentSubject])[0];
                currentTopic = topicKey;
                
                // Get questions with weak topic focus and shuffle
                currentQuestions = selectQuizQuestions();
            }

            document.getElementById('quizTitle').textContent = currentSubject + ' Quiz';
            document.getElementById('quizSubject').textContent = 'Adaptive Quiz (Random Order)';

            loadQuestion();
            startTimer();
        });

        function loadQuestion(){
            if(currentQuestionIndex >= currentQuestions.length){
                showFinalResults();
                return;
            }

            const q = currentQuestions[currentQuestionIndex];
            document.getElementById('questionProgress').textContent = `Question ${currentQuestionIndex + 1}/${currentQuestions.length}`;
            document.getElementById('questionText').textContent = q.question;

            const grid = document.getElementById('optionsGrid');
            grid.innerHTML = '';
            q.options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = `${String.fromCharCode(65 + idx)}) ${opt}`;
                btn.onclick = () => selectOption(idx, btn);
                grid.appendChild(btn);
            });

            document.getElementById('questionView').style.display = 'block';
            document.getElementById('resultView').classList.remove('show');
            document.getElementById('nextBtn').disabled = true;
        }

        function selectOption(idx, btn){
            document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            document.getElementById('nextBtn').disabled = false;
            selectedAnswers[currentQuestionIndex] = idx;
        }

        function submitAnswer(){
            if(selectedAnswers[currentQuestionIndex] === undefined){
                alert('Please select an option first!');
                return;
            }
            // Show confirmation modal instead of directly submitting
            document.getElementById('confirmModal').classList.add('active');
        }

        function closeConfirmModal(){
            document.getElementById('confirmModal').classList.remove('active');
        }

        function confirmSubmit(){
            closeConfirmModal();
            const q = currentQuestions[currentQuestionIndex];
            const isCorrect = selectedAnswers[currentQuestionIndex] === q.correct;
            scores[currentQuestionIndex] = isCorrect ? 1 : 0;

            // Show result
            document.getElementById('questionView').style.display = 'none';
            document.getElementById('resultView').classList.add('show');

            const score = scores.filter(s => s === 1).length;
            document.getElementById('resultScore').textContent = `${score}/${currentQuestionIndex + 1}`;

            if(isCorrect){
                document.getElementById('feedbackText').textContent = '‚úÖ Correct! ' + q.explanation;
                document.getElementById('feedbackText').style.backgroundColor = '#d4edda';
            }else{
                document.getElementById('feedbackText').textContent = '‚ùå Incorrect. ' + q.explanation;
                document.getElementById('feedbackText').style.backgroundColor = '#f8d7da';
            }

            document.getElementById('tipsContent').textContent = q.explanation;
            document.getElementById('weakTopicContainer').innerHTML = '';
            if(!isCorrect){
                document.getElementById('weakTopicContainer').innerHTML = `<div class="weak-topic-tag">‚ö†Ô∏è Weak Area: ${currentTopic}</div>`;
            }
        }

        function nextQuestion(){
            currentQuestionIndex++;
            if(currentQuestionIndex >= currentQuestions.length){
                showFinalResults();
            }else{
                loadQuestion();
            }
        }

        function showFinalResults(){
            const totalScore = scores.filter(s => s === 1).length;
            document.getElementById('questionView').style.display = 'none';
            document.getElementById('resultView').classList.remove('show');
            document.getElementById('finalResultsView').classList.add('show');
            
            // Update score display
            document.getElementById('reportScore').textContent = totalScore;
            const accuracy = Math.round((totalScore / currentQuestions.length) * 100);
            
            // Set score circle progress
            const scoreProgress = (accuracy / 100) * 360;
            document.getElementById('scoreCircleContainer').style.setProperty('--score-progress', scoreProgress + 'deg');
            
            // Update breakdown
            const incorrectCount = currentQuestions.length - totalScore;
            document.getElementById('correctCount').textContent = totalScore;
            document.getElementById('incorrectCount').textContent = incorrectCount;
            
            // Build concepts list
            let conceptsHTML = '';
            currentQuestions.forEach((q, idx) => {
                const isCorrect = scores[idx] === 1;
                conceptsHTML += `
                    <div class="concept-item ${isCorrect ? 'correct' : 'incorrect'}">
                        <div class="concept-title">${isCorrect ? '‚úÖ' : '‚ùå'} ${q.question}</div>
                        <div class="concept-text">${q.explanation}</div>
                    </div>
                `;
            });
            document.getElementById('conceptsList').innerHTML = conceptsHTML;
            
            // Generate AI advice
            let advice = '';
            if(accuracy >= 80) {
                advice = `üéâ Excellent work! You've demonstrated strong understanding of ${currentTopic}. Keep practicing to maintain your performance!`;
            } else if(accuracy >= 60) {
                advice = `üëç Good effort! You're on the right track. Focus on the weak areas and try to reach 80% accuracy.`;
            } else {
                advice = `üìö Keep practicing! This topic needs more review. Consider going through the study materials again and attempting practice problems.`;
            }
            document.getElementById('aiAdvice').textContent = advice;

            // Update progress tracking
            updateProgressQuiz(currentSubject, totalScore, currentQuestions.length);

            // Store attempt
            const attempt = {
                subject: currentSubject,
                topic: currentTopic,
                score: totalScore,
                outOf: currentQuestions.length,
                date: new Date().toISOString(),
                accuracy: Math.round((totalScore / currentQuestions.length) * 100)
            };
            const attemptsKey = `attempts_${localStorage.getItem('studentID') || 'demo-student'}`;
            let attempts = [];
            try{ attempts = JSON.parse(localStorage.getItem(attemptsKey) || '[]'); }catch(e){}
            attempts.push(attempt);
            try{ localStorage.setItem(attemptsKey, JSON.stringify(attempts)); }catch(e){}
        }

        function createAndSaveStudyPlan(subject, weakTopicsArray){
            const studentID = localStorage.getItem('studentID') || 'demo-student';
            const key = `studyPlans_${studentID}`;
            const now = new Date().toISOString();
            const plan = {
                id: 'plan_' + Date.now(),
                date: now,
                subject: subject,
                weakTopics: weakTopicsArray,
                days: [
                    { day: 1, title: 'Concepts & Theory', topic: weakTopicsArray[0] || 'Overview', duration: 45 },
                    { day: 2, title: 'Practice Problems', topic: weakTopicsArray[1] || 'Practice', duration: 45 },
                    { day: 3, title: 'Mock Test & Review', topic: weakTopicsArray[2] || 'Mock Test', duration: 45 }
                ]
            };
            let plans = [];
            try{ plans = JSON.parse(localStorage.getItem(key) || '[]'); } catch(e) { plans = []; }
            plans.push(plan);
            try{ localStorage.setItem(key, JSON.stringify(plans)); } catch(e) {}
            return plan;
        }

        function generateStudyPlan(){
            // Save a study plan for this student and redirect to the study-plan page
            const weakTopics = getWeakTopics();
            const weakInSubject = weakTopics.filter(w => w.subject === currentSubject);
            const weakTopicsArr = weakInSubject.map(w => w.topic);
            // persist plan
            createAndSaveStudyPlan(currentSubject, weakTopicsArr);

            const weakTopicsList = weakTopicsArr.join(',');
            const transitionOverlay = document.getElementById('pageTransition');
            if (transitionOverlay) {
                transitionOverlay.classList.remove('fade-out');
                transitionOverlay.classList.add('fade-in');
                setTimeout(() => {
                    window.location.href = `study-plan.html?subject=${currentSubject}&weakTopics=${encodeURIComponent(weakTopicsList)}`;
                }, 400);
            } else {
                window.location.href = `study-plan.html?subject=${currentSubject}&weakTopics=${encodeURIComponent(weakTopicsList)}`;
            }
        }

        function retryQuiz(){
            // Reload quiz with same subject
            const transitionOverlay = document.getElementById('pageTransition');
            if (transitionOverlay) {
                transitionOverlay.classList.remove('fade-out');
                transitionOverlay.classList.add('fade-in');
                setTimeout(() => {
                    window.location.href = `quiz.html?subject=${currentSubject}`;
                }, 400);
            } else {
                window.location.href = `quiz.html?subject=${currentSubject}`;
            }
        }

        function goBack(){
            if(confirm('Are you sure? Your progress will be lost.')){
                handleNavigation('prepsense-dashboard.html');
            }
        }

        function backToDashboard(){
            handleNavigation('prepsense-dashboard.html');
        }

        function startTimer(){
            const QUIZ_TIME_LIMIT = 5 * 60; // 5 minutes in seconds
            let timeRemaining = QUIZ_TIME_LIMIT;
            
            const timerEl = document.getElementById('quizTimer');
            
            const updateTimer = () => {
                const mins = Math.floor(timeRemaining / 60);
                const secs = timeRemaining % 60;
                const timeStr = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
                timerEl.textContent = `‚è± ${timeStr}`;
                
                // Update styling based on time remaining
                timerEl.classList.remove('warning', 'critical');
                if (timeRemaining <= 30) {
                    timerEl.classList.add('critical');
                } else if (timeRemaining <= 60) {
                    timerEl.classList.add('warning');
                }
                
                if (timeRemaining <= 0) {
                    timerEl.textContent = '‚è± Time\'s up!';
                    timerEl.classList.add('critical');
                    // Auto submit current answer
                    if (selectedAnswers[currentQuestionIndex] !== undefined) {
                        confirmSubmit();
                    }
                }
            };
            
            updateTimer(); // Initial display
            setInterval(() => {
                timeRemaining--;
                if (timeRemaining >= 0) {
                    updateTimer();
                }
            }, 1000);
        }
    </script>
    <div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div><div class="loading-text">Preparing your learning space‚Ä¶</div></div>
    <script>
        function showLoader() { const el = document.getElementById('loadingOverlay'); if(el) el.classList.add('active'); }
        function hideLoader() { const el = document.getElementById('loadingOverlay'); if(el) el.classList.remove('active'); }
        window.addEventListener('load', hideLoader);
        document.querySelector('.quiz-sidebar a')?.addEventListener('click', showLoader);
    </script>

    <!-- PAGE TRANSITION OVERLAY -->
    <div class="page-transition-overlay" id="pageTransition"></div>

    <script>
        // PAGE TRANSITION HANDLER
        document.addEventListener('DOMContentLoaded', function() {
            const transitionOverlay = document.getElementById('pageTransition');
            if (transitionOverlay) {
                transitionOverlay.classList.add('fade-out');
            }
        });

        function handleNavigation(href) {
            event && event.preventDefault();
            event && event.stopPropagation();
            const transitionOverlay = document.getElementById('pageTransition');
            if (transitionOverlay) {
                transitionOverlay.classList.remove('fade-out');
                transitionOverlay.classList.add('fade-in');
                setTimeout(() => { window.location.href = href; }, 400);
            } else {
                window.location.href = href;
            }
        }
    </script>
</html>
